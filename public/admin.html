<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>אדמין — רישום חוגים</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="light">
  <div class="container">
    <div class="header">
      <div class="logo"><a href="index.html">מועדון השחמט ראשון לציון</a></div>
      <div class="actions"><a href="index.html" class="btn">חזרה</a></div>
    </div>

    <h1>אדמין — רישום חוגים</h1>
    <div class="subtle" style="margin-bottom:8px">התחברו לניהול הרשמות, עדכון סטטוסי תשלום וחיפוש חופשי.</div>

    <!-- שער כניסה -->
    <div id="gate" class="card" style="display:grid;place-items:center;gap:12px;height:55vh; margin-top:10px">
      <div style="width:min(460px,100%);text-align:center">
        <h2>התחברות לאדמין</h2>
        <input id="adminPass" type="password" class="input" placeholder="סיסמת אדמין" style="margin-bottom:8px">
        <button class="btn primary" id="enterBtn" style="width:auto">כניסה</button>
        <div id="gateMsg" class="subtle" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- תוכן אדמין -->
    <div id="content" class="card" style="display:none">
      <div class="toolbar">
        <input id="q" class="search" placeholder="חפש לפי שם/טלפון/אימייל/כיתה/סטטוס...">
        <button id="refreshBtn" class="btn">רענן</button>
      </div>
      <div class="subtle" id="countLine" style="margin-bottom:8px"></div>
      <div style="overflow:auto">
        <table id="tbl">
          <thead>
          <tr>
            <th>חוג</th>
            <th>שם מלא</th>
            <th>אופציה</th>
            <th>סטטוס</th>
            <th>נוצר</th>
            <th>פעולות</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(function(){
  // אם הדף לא נטען מאותו שרת של ה‑API, נכוון את הקריאות לפרודקשן ב‑Render
  const isSameOrigin =
    location.origin.includes('localhost:3000') ||
    location.origin.includes('127.0.0.1:3000') ||
    location.origin.includes('classes-registration.onrender.com');

  const API_BASE = isSameOrigin ? '' : 'https://classes-registration.onrender.com';

  const state={key:'',data:[],filtered:[]};
  const $=s=>document.querySelector(s);
  const tbody=()=>$('#tbl tbody');

  const mapOpt=v=>{
    const t=String(v||'').toLowerCase();
    if(t==='both') return 'שני הימים';
    if(t==='day1') return 'יום שני';
    if(t==='day2') return 'יום רביעי';
    if(t==='single') return 'יום אחד';
    return v||'';
  };
  const badge=st=>{
    const cls = st==='paid' ? 'st-paid' : (st==='failed'||st==='canceled') ? 'st-failed' : 'st-pending';
    const icon = st==='paid' ? '✔️' : (st==='failed'||st==='canceled') ? '❌' : '⏳';
    return `<span class="status ${cls}">${icon} ${st||'pending'}</span>`;
  };
  const fmtDate=iso=>{try{return new Date(iso).toLocaleString('he-IL')}catch(e){return iso||''}};

  async function fetchEnrollments(){
    const r=await fetch(`${API_BASE}/api/admin/enrollments`, { headers:{'X-Admin-Key':state.key} });
    if(!r.ok){
      const txt = await r.text().catch(()=> '');
      throw new Error(`HTTP ${r.status}: ${txt || 'unauthorized'}`);
    }
    return r.json();
  }
  async function setStatus(id,status){
    const r=await fetch(`${API_BASE}/api/admin/enrollments/${encodeURIComponent(id)}/status`,{
      method:'POST',
      headers:{'Content-Type':'application/json','X-Admin-Key':state.key},
      body:JSON.stringify({status})
    });
    if(!r.ok){
      const txt = await r.text().catch(()=> '');
      throw new Error(`HTTP ${r.status}: ${txt || 'failed'}`);
    }
    return r.json();
  }

  function renderTable(){
    const rows = state.filtered.map(row=>`
      <tr>
        <td>${row.class_name||''}</td>
        <td>${row.full_name||''}</td>
        <td>${mapOpt(row.selected_option)}</td>
        <td>${badge(row.payment_status)}</td>
        <td>${fmtDate(row.created_at)}</td>
        <td class="row-actions">
          <button class="btn primary" data-act="paid" data-id="${row.id}">✔️ שולם</button>
          <button class="btn" data-act="pending" data-id="${row.id}">⏳ ממתין</button>
          <button class="btn" style="background:#b91c1c;color:#fff;border-color:#7f1d1d" data-act="failed" data-id="${row.id}">❌ נכשל</button>
        </td>
      </tr>`).join('');
    tbody().innerHTML = rows || `<tr><td colspan="6" class="subtle">אין נתונים</td></tr>`;
    $('#countLine').textContent = `סה״כ: ${state.data.length} | מוצגים: ${state.filtered.length}`;
  }

  function applyFilter(){
    const q=($('#q').value||'').trim().toLowerCase();
    state.filtered = !q ? state.data : state.data.filter(row =>
      [row.class_name,row.full_name,row.phone,row.email,row.payment_status,mapOpt(row.selected_option)]
        .filter(Boolean).some(v=>String(v).toLowerCase().includes(q))
    );
    renderTable();
  }

  async function refresh(){
    try{
      const data=await fetchEnrollments();
      state.data=data; state.filtered=data;
      renderTable();
      $('#gate').style.display='none';
      $('#content').style.display='';
      $('#gateMsg').textContent='';
    }catch(e){
      $('#gateMsg').textContent='סיסמה שגויה / אין הרשאה (או שה‑API לא נגיש).';
      $('#content').style.display='none';
      $('#gate').style.display='';
      console.error(e);
    }
  }

  // events
  $('#enterBtn').addEventListener('click', ()=>{ state.key=$('#adminPass').value||''; refresh(); });
  $('#q').addEventListener('input', applyFilter);
  $('#refreshBtn').addEventListener('click', refresh);
  document.addEventListener('click', async (e)=>{
    const t=e.target.closest('button[data-act]'); if(!t) return;
    try{ await setStatus(t.dataset.id,t.dataset.act); await refresh(); }
    catch(err){ alert('פעולה נכשלה'); console.error(err); }
  });
})();
</script>

</body>
</html>
