<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>אדמין — רישום חוגים</title>

  <!-- מינימום סטייל; ה-Light והפוליש באים מ-styles.css -->
  <style>
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans Hebrew","Rubik",sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .card{border-radius:16px;padding:16px}
    .gate{display:grid;gap:12px;place-items:center;height:55vh}
    input,button{font-size:16px;border-radius:12px}
    input{padding:12px 14px;min-width:280px;border:1px solid #e2e8f0;background:#fff;color:#0f172a}
    button{padding:10px 16px;cursor:pointer;border:1px solid #e2e8f0;background:#fff;color:#0f172a}
    .btn{background:#2563eb;color:#fff;border-color:#1e40af}
    .btn.alt{background:#f8fafc;color:#0f172a}
    .btn.warn{background:#b91c1c;border-color:#7f1d1d;color:#fff}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:0 0 12px}
    .search{flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid #e2e8f0}
    table{width:100%;border-collapse:collapse;font-size:14px;background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #e2e8f0;vertical-align:top}
    thead th{background:#f8fafc;color:#1f2937;text-align:right;white-space:nowrap}
    .status{padding:2px 8px;border-radius:999px;border:1px solid #cbd5e1;display:inline-block}
    .st-paid{background:#ecfdf5;border-color:#10b981;color:#065f46}
    .st-pending{background:#eff6ff;border-color:#93c5fd;color:#1e3a8a}
    .st-failed{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .muted{color:#64748b;font-size:12px}
    .hidden{display:none}
    .admin-wrap{background:#fff;border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.06);padding:16px}
  </style>

  <link rel="stylesheet" href="styles.css">
</head>
<body class="light">
  <div class="wrap">
    <div class="header" style="background:none;border:none;padding:0;margin-bottom:10px">
      <div class="logo"><a href="index.html">מועדון השחמט ראשון לציון</a></div>
      <div class="actions"><a href="index.html" class="back-btn" aria-label="חזרה">← חזרה</a></div>
    </div>

    <h1>אדמין — רישום חוגים</h1>

    <!-- שער כניסה -->
    <div id="gate" class="gate">
      <div class="admin-wrap" style="padding:24px;min-width:340px;text-align:center">
        <h2 style="margin:0 0 12px">התחברות לאדמין</h2>
        <div class="muted" style="margin-bottom:8px">הכנס סיסמת אדמין</div>
        <input id="adminPass" type="password" placeholder="הכנס סיסמת אדמין">
        <button class="btn" id="enterBtn">כניסה</button>
        <div id="gateMsg" class="muted" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- תוכן אדמין -->
    <div id="content" class="hidden">
      <div class="admin-wrap">
        <div class="toolbar">
          <input id="q" class="search" placeholder="חפש לפי שם/טלפון/אימייל/כיתה/סטטוס...">
          <button id="refreshBtn" class="btn alt">רענן</button>
        </div>
        <div class="muted" id="countLine" style="margin-bottom:8px"></div>
        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th>חוג</th>
                <th>שם מלא</th>
                <th>אופציה</th>
                <th>סטטוס</th>
                <th>נוצר</th>
                <th>פעולות</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const state = {
    key: '',        // ה-ADMIN_KEY שהמשתמש הקליד
    data: [],
    filtered: []
  };

  const el = s => document.querySelector(s);
  const tbody = () => el('#tbl tbody');

  function fmtDate(iso){
    try { const d = new Date(iso); return d.toLocaleString('he-IL'); } catch(e){ return iso||''; }
  }
  function badge(st){
    const cls = st === 'paid' ? 'st-paid' : (st === 'failed' || st === 'canceled') ? 'st-failed' : 'st-pending';
    const txt = st || 'pending';
    return `<span class="status ${cls}">${txt}</span>`;
  }
  const mapOpt = v => {
    const t = String(v||'').toLowerCase();
    if (t==='both') return 'שני הימים';
    if (t==='single') return 'יום אחד';
    if (t==='day1') return 'יום שני';
    if (t==='day2') return 'יום רביעי';
    return v || '';
  };

  async function fetchEnrollments(){
    const r = await fetch('/api/admin/enrollments', {
      headers: { 'X-Admin-Key': state.key }
    });
    if (!r.ok) throw new Error('unauthorized');
    return r.json();
  }

  async function setStatus(id, status){
    const r = await fetch(`/api/admin/enrollments/${encodeURIComponent(id)}/status`, {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-Admin-Key': state.key},
      body: JSON.stringify({ status })
    });
    if (!r.ok) throw new Error('failed to update');
    return r.json();
  }

  function applyFilter(){
    const q = (el('#q').value||'').trim().toLowerCase();
    state.filtered = !q ? state.data : state.data.filter(row => {
      return [
        row.class_name, row.full_name, row.phone, row.email, row.payment_status, mapOpt(row.selected_option)
      ].filter(Boolean).some(v => String(v).toLowerCase().includes(q));
    });
    renderTable();
  }

  function renderTable(){
    const rows = state.filtered.map(row => {
      return `<tr>
        <td>${row.class_name || ''}</td>
        <td>${row.full_name || ''}</td>
        <td>${mapOpt(row.selected_option)}</td>
        <td>${badge(row.payment_status)}</td>
        <td>${fmtDate(row.created_at)}</td>
        <td class="row-actions">
          <button class="btn" data-act="paid" data-id="${row.id}">שולם</button>
          <button class="btn alt" data-act="pending" data-id="${row.id}">ממתין</button>
          <button class="btn warn" data-act="failed" data-id="${row.id}">נכשל</button>
        </td>
      </tr>`;
    }).join('');
    tbody().innerHTML = rows || `<tr><td colspan="6" class="muted">אין נתונים</td></tr>`;
    el('#countLine').textContent = `סה״כ: ${state.data.length} | מוצגים: ${state.filtered.length}`;
  }

  async function refresh(){
    try{
      const data = await fetchEnrollments();
      state.data = data;
      state.filtered = data;
      renderTable();
    }catch(e){
      el('#gateMsg').textContent = 'שגיאה בטעינה. בדוק סיסמה/הרשאות.';
      console.error(e);
    }
  }

  // פעולות בטבלה
  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button[data-act]');
    if (!btn) return;
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    if (act === 'paid' || act === 'pending' || act === 'failed'){
      try{
        await setStatus(id, act === 'failed' ? 'failed' : act);
        await refresh();
      }catch(e){ alert('עדכון סטטוס נכשל'); console.error(e); }
    }
  });

  // שער כניסה
  el('#enterBtn').addEventListener('click', async () => {
    const pass = (el('#adminPass').value || '').trim();
    if (!pass) return;
    state.key = pass;
    try{
      await refresh();
      el('#gate').classList.add('hidden');
      el('#content').classList.remove('hidden');
    }catch(e){
      el('#gateMsg').textContent = 'סיסמה שגויה או שאין הרשאה.';
    }
  });

  el('#refreshBtn').addEventListener('click', refresh);
  el('#q').addEventListener('input', applyFilter);
})();
</script>
</body>
</html>
