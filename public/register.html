<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>טופס הרשמה לחוג</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="page-register light">
  <div class="container">
    <div class="header">
      <div  class="logo">
        <img width="55px" src="/images/logo.png"></img>
        <div><a href="index.html">הרשמה לחוגים</a></div>
      </div>
      <div class="actions"><a href="index.html" class="btn" aria-label="חזרה">חזרה</a></div>
    </div>

    <h1 id="classTitle">שם החוג</h1>
    <div id="classMeta" class="subtle">רמה • מאמן/ת</div>

    <div class="card" style="margin-top:14px;">
      <div>
        <label class="meet-label" style="font-size:18px;font-weight:700;display:inline-flex;align-items:center;gap:10px">
          בחירת ימי מפגש
          <select id="meetingOption" required>
            <option value="">בחר אפשרות</option>
            <option value="both">שני המפגשים (שני+רביעי)</option>
            <option value="day1">יום שני</option>
            <option value="day2">יום רביעי</option>
          </select>
        </label>
        <div id="sessionsList" class="sessions"></div>
      </div>

      <h3 style="margin-top:10px;">פרטי המשתתף/ת</h3>
      <form id="regForm" class="form">
        <input type="hidden" id="groupKey" value="">
        <div><label>שם פרטי<input id="firstName" required></label></div>
        <div><label>שם משפחה<input id="lastName" required></label></div>
        <div><label>תאריך לידה<input id="birthDate" type="date"></label></div>
        <div><label>שם הורה (אם רלוונטי)<input id="parentName"></label></div>
        <div><label>טלפון<input id="phone" required></label></div>
        <div><label>אימייל<input id="email" type="email"></label></div>
        <div class="full"><label>הערות<textarea id="notes" rows="3" placeholder="מידע רפואי/בקשות"></textarea></label></div>

        <div class="full payrow">
          <div><span>סכום לתשלום:</span> <span class="amount" id="paybarAmount">0₪</span></div>
          <button type="button" class="btn primary" id="payBtn">מעבר לתשלום 🔒</button>
        </div>
      </form>
      <div class="subtle" style="margin-top:8px">התשלום מתבצע דרך Meshulam בצורה מאובטחת.</div>
    </div>
  </div>

<script src="script.js"></script>
<script src="payments.js"></script>
<script>
(function(){
  const sp=new URL(location.href).searchParams;
  const g=sp.get('group')||sp.get('groupId')||'';
  if(g){ document.body.dataset.group=g; const h=document.getElementById('groupKey'); if(h) h.value=g; }
  

  const sel=document.getElementById('meetingOption');
  const pay=document.getElementById('paybarAmount');
  const sessions=document.getElementById('sessionsList');

  function getGrp(){ return window.RCC?.classGroups?.find(x=>x.id === (document.body.dataset.group||'')); }
  function hasTwoSessions(grp){ return Array.isArray(grp?.sessions) && grp.sessions.length >= 2; }
  function parsePrice(p){ // מקבל "₪235/₪355" או "₪195"
    const raw = String(p||'').replace(/\s+/g,'');
    const m = raw.match(/₪?(\d{2,5})\/₪?(\d{2,5})/);
    if(m){ return { one: Math.min(+m[1],+m[2]), both: Math.max(+m[1],+m[2]) }; }
    const m2 = raw.match(/₪?(\d{2,5})$/);
    if(m2){ return { one:+m2[1], both:null }; }
    return { one:0, both:null };
  }

  function renderSessions(){
    const grp = getGrp(); if(!grp) return;
    document.getElementById('classTitle').textContent = grp.title;
    document.getElementById('classMeta').textContent  = `מד כושר ${String(grp.level).replace('-', '–')} • מאמן/ת: ${grp.coach}`;

    sessions.innerHTML = grp.sessions.map(s=>`<span class="session">${s.dayName} • ${s.time}</span>`).join('');

    const price = parsePrice(grp.price);

    console.log('Group:', grp, 'Parsed price:', price);
    

    if(hasTwoSessions(grp)){
      // השאר את הבחירה גלויה ודרוש בחירה ידנית
      sel.value = '';
      sel.parentElement.style.display = '';
      pay.textContent = '0₪';
    }else{
      // חוג חד-יומי: הסתר בחירה, קבע option='single', הצג מחיר
      sel.value = 'single';
      sel.parentElement.style.display = 'none';
      pay.textContent = (price.one||0) + '₪';
    }
  }

  function updateAmount(){
    const grp = getGrp(); if(!grp) return;
    const price = parsePrice(grp.price);
    const v = sel.value;
    const amount = v==='both' ? (price.both||0) : v ? (price.one||0) : 0;
    pay.textContent = amount + '₪';

    if(!hasTwoSessions(grp)
    ){
      pay.textContent = (price.one||0) + '₪';
    }
    
  }

  if(sel && pay){
    sel.addEventListener('change', ()=>{ sel.dataset.userSelected='1'; updateAmount(); });
  }

  renderSessions();
  updateAmount();

  // Guard + תשלום
  document.getElementById('payBtn').addEventListener('click', (e)=>{ window.guardAndPay(e); });

  // מניעת דאבל-אינסרט בחזרה מהתשלום
  window.addEventListener('pageshow', (e)=>{ if(e.persisted){ location.reload(); } });
})();
</script>

</body>
</html>
