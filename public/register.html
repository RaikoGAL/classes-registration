<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>טופס הרשמה לחוג</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="page-register light">
  <div class="container">
    <div class="header">
      <div class="logo"><a href="index.html">מועדון השחמט ראשון לציון</a></div>
      <div class="actions"><a href="index.html" class="btn" aria-label="חזרה">חזרה</a></div>
    </div>

    <h1 id="classTitle">שם החוג</h1>
    <div id="classMeta" class="subtle">רמה • מאמן/ת</div>

    <div class="card" style="margin-top:14px;">
      <div>
        <label class="meet-label" style="font-size:18px;font-weight:700;display:inline-flex;align-items:center;gap:10px">
          בחירת ימי מפגש
          <select id="meetingOption" required>
            <option value="">בחר אפשרות</option>
            <option value="both">שני המפגשים (שני+רביעי)</option>
            <option value="day1">יום שני</option>
            <option value="day2">יום רביעי</option>
          </select>
        </label>
        <div id="sessionsList" class="sessions"></div>
      </div>

      <h3 style="margin-top:10px;">פרטי המשתתף/ת</h3>
      <form id="regForm" class="form">
        <input type="hidden" id="groupKey" value="">
        <div><label>שם פרטי<input id="firstName" required></label></div>
        <div><label>שם משפחה<input id="lastName" required></label></div>
        <div><label>תאריך לידה<input id="birthDate" type="date"></label></div>
        <div><label>שם הורה (אם רלוונטי)<input id="parentName"></label></div>
        <div><label>טלפון<input id="phone" required></label></div>
        <div><label>אימייל<input id="email" type="email"></label></div>
        <div class="full"><label>הערות<textarea id="notes" rows="3" placeholder="מידע רפואי/בקשות"></textarea></label></div>

        <div class="full payrow">
          <div><span>סכום לתשלום:</span> <span class="amount" id="paybarAmount">0₪</span></div>
          <button type="button" class="btn primary" id="payBtn">מעבר לתשלום 🔒</button>
        </div>
      </form>
      <div class="subtle" style="margin-top:8px">התשלום מתבצע דרך Meshulam בצורה מאובטחת.</div>
    </div>
  </div>

  <script src="script.js"></script>
  <script src="payments.js"></script>
  <script>
  (function(){
    // קבלת groupId מה-URL ושמירה לשדה חבוי
    const sp=new URL(location.href).searchParams;
    const g=sp.get('group')||sp.get('groupId')||'';
    if(g){ document.body.dataset.group=g; const h=document.getElementById('groupKey'); if(h) h.value=g; }

    // עדכון סכום לפי בחירה (ברירת מחדל 0₪)
    const PRICE_ONE=235, PRICE_BOTH=355;
    const sel=document.getElementById('meetingOption');
    const pay=document.getElementById('paybarAmount');
    const sessions=document.getElementById('sessionsList');

    function amountFor(v){ if(v==='both')return PRICE_BOTH; if(v==='day1'||v==='day2')return PRICE_ONE; return 0; }
    function update(){ pay.textContent = amountFor(sel.value) + '₪'; }
    if(sel&&pay){ update(); sel.addEventListener('change', ()=>{ sel.dataset.userSelected='1'; update(); }); }

    // הצגת קפסולות שעות מתוך הנתונים שב-script.js
    function renderSessions(){
      const groupId = document.body.dataset.group || '';
      const grp = window.RCC?.classGroups?.find(x=>x.id===groupId);
      sessions.innerHTML = grp
        ? grp.sessions.map(s=>`<span class="session">${s.dayName} • ${s.time}</span>`).join('')
        : '';
      // אם לא בחר ידנית — לא לבחור אוטומטית
      if(!sel.dataset.userSelected) sel.value='';
      update();
    }
    renderSessions();

    // Guard: למנוע תשלום בלי בחירה
    document.getElementById('payBtn').addEventListener('click', (e)=>{
      if(!sel.value){ alert('נא לבחור ימי מפגש לפני מעבר לתשלום'); sel.focus(); return; }
      window.guardAndPay?.(e);
    });

    // מניעת דאבל-אינסרט בחזרה מהתשלום
    window.addEventListener('pageshow', (e)=>{
      if(e.persisted){ location.reload(); }
    });
  })();
  </script>
</body>
</html>
